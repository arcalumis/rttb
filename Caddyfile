# Caddyfile for production deployment
# Automatically handles HTTPS with Let's Encrypt

{$DOMAIN:localhost} {
	# Enable gzip compression
	encode gzip

	# Security headers
	header {
		# Prevent clickjacking
		X-Frame-Options "SAMEORIGIN"
		# Prevent MIME type sniffing
		X-Content-Type-Options "nosniff"
		# XSS protection
		X-XSS-Protection "1; mode=block"
		# Referrer policy
		Referrer-Policy "strict-origin-when-cross-origin"
		# Remove server header
		-Server
	}

	# Reverse proxy to the Bun app
	reverse_proxy app:3001 {
		# Health checks
		health_uri /api/health
		health_interval 30s
		health_timeout 10s

		# Headers
		header_up Host {host}
		header_up X-Real-IP {remote_host}
		header_up X-Forwarded-For {remote_host}
		header_up X-Forwarded-Proto {scheme}
	}

	# Logging
	log {
		output stdout
		format console
		level INFO
	}
}

# Handle www subdomain - redirect to non-www
www.{$DOMAIN:localhost} {
	redir https://{$DOMAIN:localhost}{uri} permanent
}
